{% extends "base.html" %}

{% block title %}Scraping Results - Link Scraper{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Header with Download Button -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2>
                    <i class="fas fa-check-circle text-success me-2"></i>
                    {% if data.get('is_comprehensive') %}
                        Comprehensive Scan Complete
                    {% else %}
                        Single Page Scan Complete
                    {% endif %}
                </h2>
                <p class="text-muted mb-0">
                    {% if data.get('is_comprehensive') %}
                        Content extracted from {{ data.get('pages_scraped', 1) }} pages across the website
                    {% else %}
                        Content successfully extracted from the website
                    {% endif %}
                </p>
            </div>
            <div>
                <a href="{{ url_for('index') }}" class="btn btn-outline-secondary me-2">
                    <i class="fas fa-arrow-left me-2"></i>
                    Scrape Another
                </a>
                <div class="btn-group">
                    <form method="POST" action="{{ url_for('download_pdf') }}" class="d-inline" id="pdfForm">
                        <input type="hidden" name="url" value="{{ data.url }}">
                        <input type="hidden" name="title" value="{{ data.title or '' }}">
                        <input type="hidden" name="content" value="{{ data.content or '' }}">
                        <input type="hidden" name="links_data" value="{{ data.links | tojson }}">
                        <input type="hidden" name="images_data" value="{{ data.images | tojson }}">
                        <input type="hidden" name="is_comprehensive" value="{{ 'true' if data.get('is_comprehensive') else 'false' }}">
                        <button type="submit" class="btn btn-primary" onclick="showProgressModal()">
                            <i class="fas fa-file-pdf me-2"></i>
                            PDF
                        </button>
                    </form>
                    <form method="POST" action="{{ url_for('download_csv') }}" class="d-inline">
                        <input type="hidden" name="url" value="{{ data.url }}">
                        <input type="hidden" name="title" value="{{ data.title or '' }}">
                        <input type="hidden" name="content" value="{{ data.content or '' }}">
                        <input type="hidden" name="links_data" value="{{ data.links | tojson }}">
                        <input type="hidden" name="images_data" value="{{ data.images | tojson }}">
                        <input type="hidden" name="is_comprehensive" value="{{ 'true' if data.get('is_comprehensive') else 'false' }}">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-file-csv me-2"></i>
                            CSV
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Website Info Card -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Website Information
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-2 fw-bold">Title:</div>
                    <div class="col-md-10">{{ data.title or 'No title found' }}</div>
                </div>
                <hr class="my-2">
                <div class="row">
                    <div class="col-md-2 fw-bold">URL:</div>
                    <div class="col-md-10">
                        <a href="{{ data.url }}" target="_blank" class="text-decoration-none">
                            {{ data.url }}
                            <i class="fas fa-external-link-alt ms-1 small"></i>
                        </a>
                        <button type="button" class="btn btn-sm btn-outline-info ms-3" data-bs-toggle="modal" data-bs-target="#previewModal">
                            <i class="fas fa-eye me-1"></i> Preview Site
                        </button>
                    </div>
                </div>
                <hr class="my-2">
                <div class="row">
                    <div class="col-md-2 fw-bold">Content Length:</div>
                    <div class="col-md-10">
                        {% if data.content %}
                            {{ data.content | length }} characters
                        {% else %}
                            No content extracted
                        {% endif %}
                    </div>
                </div>
                <hr class="my-2">
                <div class="row">
                    <div class="col-md-2 fw-bold">Links Found:</div>
                    <div class="col-md-10">{{ data.links | length }} unique links</div>
                </div>
                {% if data.images %}
                <hr class="my-2">
                <div class="row">
                    <div class="col-md-2 fw-bold">Images Found:</div>
                    <div class="col-md-10">{{ data.images | length }} images</div>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="row">
            <!-- Main Content -->
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-file-text me-2"></i>
                            Extracted Content
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if data.content %}
                            <div class="content-preview" style="max-height: 500px; overflow-y: auto;">
                                {% for paragraph in data.content.split('\n') %}
                                    {% if paragraph.strip() %}
                                        <p class="mb-2">{{ paragraph.strip() }}</p>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                                <p>No main content could be extracted from this website.</p>
                                <small>This might be due to the website structure or content protection.</small>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Links Sidebar -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-link me-2"></i>
                            Links Found ({{ data.links | length }})
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        {% if data.links %}
                            <div class="list-group list-group-flush" style="max-height: 500px; overflow-y: auto;">
                                {% for link in data.links[:20] %}
                                    <div class="list-group-item">
                                        <div class="d-flex w-100 justify-content-between align-items-start">
                                            <div class="flex-grow-1 me-2">
                                                <h6 class="mb-1 small">{{ link.text[:50] }}{% if link.text | length > 50 %}...{% endif %}</h6>
                                                <small class="text-muted text-break">{{ link.url[:60] }}{% if link.url | length > 60 %}...{% endif %}</small>
                                            </div>
                                            <a href="{{ link.url }}" target="_blank" class="btn btn-outline-primary btn-sm">
                                                <i class="fas fa-external-link-alt"></i>
                                            </a>
                                        </div>
                                    </div>
                                {% endfor %}
                                {% if data.links | length > 20 %}
                                    <div class="list-group-item text-center text-muted">
                                        <small>... and {{ data.links | length - 20 }} more links</small>
                                    </div>
                                {% endif %}
                            </div>
                        {% else %}
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-unlink fa-2x mb-3"></i>
                                <p>No links found on this website.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Download Card -->
                <div class="card mt-3">
                    <div class="card-body text-center">
                        <h6 class="card-title">
                            <i class="fas fa-download me-2"></i>
                            Export Options
                        </h6>
                        <p class="card-text small text-muted mb-3">
                            Download your data as PDF or CSV format
                            {% if data.get('is_comprehensive') %}
                                ({{ data.get('pages_scraped', 1) }} pages scanned)
                            {% endif %}
                        </p>
                        <div class="d-grid gap-2">
                            <form method="POST" action="{{ url_for('download_pdf') }}">
                                <input type="hidden" name="url" value="{{ data.url }}">
                                <input type="hidden" name="title" value="{{ data.title or '' }}">
                                <input type="hidden" name="content" value="{{ data.content or '' }}">
                                <input type="hidden" name="links_data" value="{{ data.links | tojson }}">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-file-pdf me-2"></i>
                                    Download as PDF
                                </button>
                            </form>
                            <form method="POST" action="{{ url_for('download_csv') }}">
                                <input type="hidden" name="url" value="{{ data.url }}">
                                <input type="hidden" name="title" value="{{ data.title or '' }}">
                                <input type="hidden" name="content" value="{{ data.content or '' }}">
                                <input type="hidden" name="links_data" value="{{ data.links | tojson }}">
                                <button type="submit" class="btn btn-success w-100">
                                    <i class="fas fa-file-csv me-2"></i>
                                    Download as CSV
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Images Section (if available) -->
        {% if data.images %}
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-image me-2"></i>
                    Images Found ({{ data.images | length }})
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    {% for image in data.images[:12] %}
                    <div class="col-md-3 col-sm-6">
                        <div class="card h-100">
                            <div class="card-body text-center p-2">
                                <small class="text-muted d-block mb-2 text-truncate" title="{{ image.title }}">
                                    {{ image.title[:30] }}{% if image.title | length > 30 %}...{% endif %}
                                </small>
                                <div class="bg-light p-2 rounded" style="min-height: 100px; display: flex; align-items: center; justify-content: center;">
                                    <img src="{{ image.url }}" 
                                         alt="{{ image.alt or image.title }}" 
                                         class="img-fluid"
                                         style="max-height: 150px; max-width: 100%;"
                                         onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'100\' height=\'100\' viewBox=\'0 0 100 100\'%3E%3Crect width=\'100\' height=\'100\' fill=\'%23ddd\'/%3E%3Ctext x=\'50\' y=\'50\' font-family=\'Arial\' font-size=\'12\' fill=\'%23999\' text-anchor=\'middle\' dominant-baseline=\'middle\'%3EImage Not Found%3C/text%3E%3C/svg%3E';">
                                </div>
                                <div class="mt-2">
                                    <input type="text" class="form-control form-control-sm" value="{{ image.url }}" readonly onclick="this.select()">
                                    <button class="btn btn-sm btn-outline-secondary mt-1 w-100" onclick="copyImageUrl('{{ image.url }}')">
                                        <i class="fas fa-copy"></i> Copy Address
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% if data.images | length > 12 %}
                <div class="text-center mt-3">
                    <small class="text-muted">... and {{ data.images | length - 12 }} more images</small>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Progress Modal for PDF Generation -->
<div class="modal fade" id="progressModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-file-pdf me-2"></i>
                    Generating PDF
                </h5>
            </div>
            <div class="modal-body">
                <p class="mb-3">Please wait while we generate your PDF...</p>
                <div class="progress" style="height: 25px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" 
                         id="progressBar"
                         style="width: 0%"
                         aria-valuenow="0" 
                         aria-valuemin="0" 
                         aria-valuemax="100">0%</div>
                </div>
                <div class="mt-3 text-muted small" id="progressStatus">Initializing...</div>
            </div>
        </div>
    </div>
</div>

<!-- Site Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-eye me-2"></i>
                    Site Preview
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <iframe src="{{ data.url }}" 
                        style="width: 100%; height: 500px; border: 1px solid #ddd; border-radius: 4px;"
                        sandbox="allow-same-origin allow-scripts"
                        title="Website Preview"></iframe>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Copy image URL to clipboard
function copyImageUrl(url) {
    navigator.clipboard.writeText(url).then(function() {
        // Show temporary success message
        const btn = event.target.closest('button');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
        btn.classList.remove('btn-outline-secondary');
        btn.classList.add('btn-success');
        setTimeout(() => {
            btn.innerHTML = originalHTML;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-secondary');
        }, 2000);
    });
}

// Show progress modal for PDF generation
function showProgressModal() {
    const modal = new bootstrap.Modal(document.getElementById('progressModal'));
    modal.show();
    
    let progress = 0;
    const progressBar = document.getElementById('progressBar');
    const progressStatus = document.getElementById('progressStatus');
    
    // Simulate progress updates
    const statuses = [
        'Connecting to server...',
        'Fetching website content...',
        'Processing images...',
        'Formatting document...',
        'Generating PDF file...',
        'Finalizing...'
    ];
    
    let statusIndex = 0;
    const interval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress > 95) progress = 95;
        
        progressBar.style.width = progress + '%';
        progressBar.setAttribute('aria-valuenow', progress);
        progressBar.textContent = Math.round(progress) + '%';
        
        if (statusIndex < statuses.length) {
            progressStatus.textContent = statuses[statusIndex];
            statusIndex++;
        }
        
        // When form actually submits, progress will complete
        if (progress >= 95) {
            clearInterval(interval);
            progressBar.style.width = '100%';
            progressBar.textContent = '100%';
            progressStatus.textContent = 'Download starting...';
        }
    }, 500);
}

document.addEventListener('DOMContentLoaded', function() {
    // Add smooth scrolling for better UX
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            document.querySelector(this.getAttribute('href')).scrollIntoView({
                behavior: 'smooth'
            });
        });
    });
});
</script>
{% endblock %}
